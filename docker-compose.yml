services:
  mongodb:
    image: mongo:7
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db

  backend:
    build:
      context: ./backend
    ports:
      - "8000:8000"
    environment:
      STYLEAGENT_DB_URL: ${STYLEAGENT_DB_URL:-mongodb://mongodb:27017/styleagent}
      MONGO_DB_NAME: ${MONGO_DB_NAME:-styleagent}
    depends_on:
      - mongodb

  frontend:
    build:
      context: ./frontend
      args:
        VITE_API_BASE_URL: ${FRONTEND_API_BASE_URL:-http://localhost:8000}
        VITE_API_TIMEOUT_MS: ${FRONTEND_API_TIMEOUT_MS:-10000}
        VITE_APP_BASE_PATH: ${FRONTEND_APP_BASE_PATH:-/}
    ports:
      - "5173:80"
    depends_on:
      - backend

  runner:
    build:
      context: ./runner
    command: ["styleagent-runner", "poll"]
    environment:
      RUNNER_API_BASE_URL: ${RUNNER_API_BASE_URL:-http://backend:8000}
      RUNNER_POLL_INTERVAL: ${RUNNER_POLL_INTERVAL:-5}
      RUNNER_API_KEY: ${RUNNER_API_KEY:-}
      RUNNER_HTTP_TIMEOUT_SECONDS: ${RUNNER_HTTP_TIMEOUT_SECONDS:-10}
      RUNNER_HTTP_RETRIES: ${RUNNER_HTTP_RETRIES:-2}
    depends_on:
      - backend
    restart: unless-stopped

volumes:
  mongodb_data:
